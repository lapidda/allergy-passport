<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{profile.title} + ' | Allergy Passport'">Profile | Allergy Passport</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#FFF7ED', 100: '#FFEDD5', 200: '#FED7AA', 300: '#FDBA74', 400: '#FB923C', 500: '#F97316', 600: '#EA580C', 700: '#C2410C', 800: '#9A3412', 900: '#7C2D12' },
                        beige: { 50: '#FAF7F2', 100: '#F5EFE7', 200: '#E8DCC8', 300: '#D4C4A8', 400: '#C0AB88' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-beige-50 min-h-screen">
    <!-- Navigation from layout -->
    <div th:replace="~{layout :: nav}"></div>

    <main class="max-w-3xl mx-auto py-6 px-4 sm:py-8 sm:px-6 lg:px-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-6 sm:mb-8" th:text="#{profile.title}">Profile Settings</h1>

        <div class="bg-white shadow rounded-lg divide-y divide-gray-200">
            <!-- Profile Picture Section -->
            <div class="p-4 sm:p-6">
                <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4" th:text="#{profile.picture}">Profile Picture</h2>

                <div id="profile-picture-section" class="flex flex-col sm:flex-row items-center sm:space-x-6 space-y-4 sm:space-y-0">
                    <!-- Current Picture -->
                    <div class="shrink-0">
                        <img th:if="${user.hasCustomProfilePicture()}"
                             th:src="@{/profile-picture/{id}(id=${user.publicId})}"
                             class="h-20 w-20 sm:h-24 sm:w-24 object-cover rounded-full border-4 border-gray-200"
                             alt="Profile picture"/>
                        <img th:unless="${user.hasCustomProfilePicture()}"
                             th:src="${user.googlePictureUrl} ?: 'https://ui-avatars.com/api/?name=' + ${user.displayName} + '&background=3b82f6&color=fff&size=96'"
                             class="h-20 w-20 sm:h-24 sm:w-24 object-cover rounded-full border-4 border-gray-200"
                             alt="Profile picture"/>
                    </div>

                    <!-- Upload Form -->
                    <div class="flex-1 w-full">
                        <form hx-post="/api/profile/picture"
                              hx-encoding="multipart/form-data"
                              hx-target="#profile-picture-section"
                              hx-swap="innerHTML"
                              class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4">
                            <input type="file"
                                   name="picture"
                                   accept="image/*"
                                   class="block w-full text-sm text-gray-500
                                          file:mr-4 file:py-2 file:px-4
                                          file:rounded-md file:border-0
                                          file:text-sm file:font-medium
                                          file:bg-primary-50 file:text-primary-700
                                          hover:file:bg-primary-100"/>
                            <button type="submit"
                                    class="w-full sm:w-auto px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 transition-colors"
                                    th:text="#{profile.picture.upload}">Upload</button>
                        </form>

                        <div th:if="${user.hasCustomProfilePicture()}" class="mt-3">
                            <button hx-delete="/api/profile/picture"
                                    hx-target="#profile-picture-section"
                                    hx-swap="innerHTML"
                                    hx-confirm="Remove your custom profile picture?"
                                    class="text-sm text-red-600 hover:text-red-800"
                                    th:text="#{profile.picture.remove}">Remove Picture</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Info Section -->
            <div class="p-4 sm:p-6">
                <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-4" th:text="#{profile.info}">Profile Information</h2>

                <form hx-post="/api/profile"
                      hx-target="#profile-form-messages"
                      hx-swap="innerHTML"
                      class="space-y-4 sm:space-y-6">
                    
                    <!-- Messages Container -->
                    <div id="profile-form-messages"></div>
                    
                    <!-- Display Name -->
                    <div>
                        <label for="displayName" class="block text-sm font-medium text-gray-700" th:text="#{profile.displayName}">Display Name</label>
                        <input type="text" 
                               id="displayName" 
                               name="displayName" 
                               th:value="${user.displayName}"
                               maxlength="100"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 py-2 px-3 border"/>
                    </div>

                    <!-- Email (Read-only) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700" th:text="#{profile.email}">Email</label>
                        <input type="email"
                               th:value="${user.email}"
                               disabled
                               class="mt-1 block w-full rounded-md border-gray-200 bg-gray-50 text-gray-500 py-2 px-3 border"/>
                        <p class="mt-1 text-xs text-gray-500" th:text="#{profile.email.note}">Email is managed by your Google account</p>
                    </div>

                    <!-- Bio -->
                    <div>
                        <label for="bio" class="block text-sm font-medium text-gray-700" th:text="#{profile.bio}">Bio / Description</label>
                        <textarea id="bio"
                                  name="bio"
                                  rows="3"
                                  maxlength="500"
                                  th:placeholder="#{profile.bio.placeholder}"
                                  th:text="${user.bio}"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 py-2 px-3 border"></textarea>
                        <p class="mt-1 text-xs text-gray-500" th:text="#{profile.bio.note}">This will be shown on your public allergy passport</p>
                    </div>

                    <!-- Public ID (Read-only) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700" th:text="#{profile.publicId}">Public ID</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                                /u/
                            </span>
                            <input type="text"
                                   th:value="${user.publicId}"
                                   disabled
                                   class="flex-1 block w-full rounded-none rounded-r-md border-gray-200 bg-gray-50 text-gray-500 py-2 px-3 border"/>
                        </div>
                        <p class="mt-1 text-xs text-gray-500" th:text="#{profile.publicId.note}">This is your unique public identifier and cannot be changed</p>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end pt-2">
                        <button type="submit"
                                class="w-full sm:w-auto px-6 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 transition-colors"
                                th:text="#{profile.save}">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Profile Form Fragment for HTMX updates -->
    <template id="success-message">
        <div class="rounded-md bg-green-50 p-4 mb-4">
            <div class="flex">
                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <p class="ml-3 text-sm font-medium text-green-800" th:text="#{profile.success}">Profile updated successfully</p>
            </div>
        </div>
    </template>
</body>
</html>
